# Terraform

# Terraform: Up & Running

**DevOps** - это набор процессов, идей и методик. Цель DevOps — значительно повысить эффективность доставки ПО. Движение DevOps основано на четырех принципах: культуре, автоматизации, измерении и разделении. Задача — автоматизировать как можно больше аспектов процесса доставки программного обеспечения.

Инструменты IaC
- специализированные скрипты;
- средства управления конфигурацией;
- средства шаблонизации серверов;
- средства оркестрации;
- средства инициализации ресурсов.

Преимущества инфраструктуры как кода
- Самообслуживание
- Скорость и безопасность
- Документация
- Управление версиями
- Проверка
- Повторное использование
- Радость

**Как работает Terraform**

Terraform — это инструмент с открытым исходным кодом от компании HashiCorp, написанный на языке программирования Go. Код на Go компилируется в единый двоичный файл с предсказуемым названием terraform. Этот файл позволяет развернуть инфраструктуру прямо с вашего ноутбука или сборочного сервера (либо любого другого компьютера), и для всего этого не требуется никакой дополнительной инфраструктуры. Terraform использует инфраструктуру, которую провайдеры предоставляют для своих API-серверов, а также их механизмы аутентификации.


**Установка Terraform**

https://www.terraform.io - выберите подходящий пакет для своей операционной системы, сохраните ZIP-архив и распакуйте его в папку, в которую хотите установить Terraform. Архив содержит единственный двоичный файл под названием terraform, который следует добавить в переменную среды PATH.

Чтобы система Terraform могла вносить изменения в вашу учетную запись AWS, нужно прописать в переменных среды AWS_ACCESS_KEY_ID и AWS_SECRET_ACCESS_KEY

**Развертывание одного сервера**

Код Terraform пишется на языке конфигурации HashiCorp и хранится в файлах с расширением .tf. Это декларативный язык, поэтому ваша задача — описать нужную вам инфраструктуру, а Terraform разберется с тем, как ее создать.

Первым делом при использовании Terraform обычно следует выбрать провайдера (одного или несколько), с которым вы хотите работать. Создайте пустую папку и поместите в нее файл с именем main.tf
```
   provider "aws" {
     region = "us-east-2"
}
```
Это говорит Terraform о том, что в качестве провайдера вы собираетесь использовать AWS и хотите развертывать свою инфраструктуру в регионе us-east-2. Регионы AWS — это отдельные географические области. Внутри каждой области находится несколько изолированных вычислительных центров, известных как зоны доступности.

Каждый тип провайдеров поддерживает создание разного вида ресурсов. Обобщенный синтаксис создания ресурса в Terraform выглядит так:
```
resource "<PROVIDER>_<TYPE>" "<NAME>" {
      [CONFIG ...]
}
```
- PROVIDER — имя провайдер
- TYPE — тип ресурса
- NAME — идентификатор
- CONFIG содержит один или несколько аргументов, предусмотренных специально для этого ресурса
```
terraform init
```
Исполняемый файл terraform поддерживает основные команды Terraform, но он не содержит никакого кода для провайдеров (вроде AWS, Azure или GCP). Поэтому, начиная работу с этим инструментом, вы должны выполнить **terraform init**, чтобы он мог просканировать ваш код, определить, с какими провайдерами вы работаете, и загрузить для них подходящие модули. По умолчанию код провайдеров загружается в папку .terraform.
```
terraform plan
```
Команда plan позволяет увидеть, что сделает Terraform, без внесения каких-либо изменений - знак плюс (+) помечает все, что будет создано; знак минус (-) — что будет удалено, а то, что помечено тильдой (~), будет изменено. Символы -/+ в выводе плана означают «заменить».

Чтобы инициировать создание сервера, нужно выполнить команду **terraform apply**

Запустить скрипт Hello, World в рамках конфигурации пользовательских данных вашего сервера EC2. Вы можете передать параметру user_data в коде Terraform то, что будет выполнено при загрузке сервера: либо скрипт командной оболочки, либо директиву cloud-init.
```
user_data = <<-EOF
                 #!/bin/bash
                 echo "Hello, World" > index.html
                 nohup busybox httpd -f -p 8080 &
                 EOF
```
Чтобы ваш сервер мог принимать запросы на порте 8080, необходимо создать группу безопасности:
```
resource "aws_security_group" "instance" { ... }
```
Этот код создает новый ресурс под названием aws_security_group. Создания группы безопасности как таковой будет недостаточно. Нужно сделать так, чтобы сервер EC2 ее использовал. Для этого вы должны передать ее идентификатор аргументу vpc_security_group_ids ресурса aws_instance.

В Terraform выражением является все, что возвращает значение. Вы уже видели простейший тип выражений — литералы, такие как строки и числа.

Особенно полезным типом выражений является ссылка, которая позволяет обращаться к значениям с других участков кода. Чтобы указать ID группы безопасности, нужно сослаться на атрибут ресурса с помощью такого синтаксиса:
```
   <PROVIDER>_<TYPE>.<NAME>.<ATTRIBUTE>
```
- PROVIDER — это имя провайдера
- TYPE — это тип ресурса
- NAME — имя этого ресурса
- ATTRIBUTE — это либо один из аргументов ресурса
```
vpc_security_group_ids = [aws_security_group.instance.id]
```
Ссылаясь в одном ресурсе на другой, вы создаете неявную зависимость. Terraform анализирует такие зависимости, строит из них граф и применяет его для автоматического определения порядка, в котором должны создаваться ресурсы.

Можете даже вывести граф зависимостей с помощью команды graph:
```
terraform graph
```
Чтобы можно было сделать ваш код более конфигурируемым и отвечающим принципу DRY, Terraform позволяет определять входные переменные.
```
  variable "NAME" {
     [CONFIG ...]
}
```
Тело объявления переменной может содержать три необязательных параметра:
- description - Этот параметр всегда желательно указывать для документирования
- default - Вы можете присвоить значение переменной несколькими способами, в том числе через командную строку (с помощью параметра -var), файл (указывая параметр -var-file) или переменную среды (Terraform ищет переменные среды вида TF_VAR_<имя_переменной>). Если переменная не инициализирована, ей присваивается значение по умолчанию.
- type - Позволяет применить к переменным, которые передает пользователь, ограничения типов. Terraform поддерживает ряд ограничений для таких типов, как string, number, bool, list, map, set, object, tuple и any. Если тип не указан, Terraform воспринимает значение как any.
```
terraform plan -var "server_port=8080"
export TF_VAR_server_port=8080
```
Указать ссылку внутри строкового литерала можно с помощью строковой интерполяции, которая имеет следующий синтаксис:
```
"${...}"
```
Помимо входных переменных, Terraform позволяет определять и выходные.
```
 output "<NAME>" {
     value = <VALUE>
      [CONFIG ...]
   }
```
- NAME — это имя выходной переменной
- VALUE можно указать любое выражение
- CONFIG может иметь два дополнительных параметра
  - description - для документирования
  - sensitive - Если присвоить данному параметру true, Terraform не станет сохранять этот вывод в журнал после выполнения команды terraformapply. Это полезно, когда переменная содержит конфиденциальные данные.

**terraform output** - вывод списка всех выходных значений без применения каких-либо изменений.

Значение определенной выходной переменной, можно воспользоваться командой terraform output <ИМЯ_ПЕРЕМЕННОЙ>:
```
terraform output public_ip
```
